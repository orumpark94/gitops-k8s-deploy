- name: Deploy ArgoCD to Kubernetes
  hosts: master
  become: yes
  tasks:

    # 1ï¸âƒ£ Helm ì„¤ì¹˜ í™•ì¸
    - name: Check if Helm is installed
      stat:
        path: /usr/local/bin/helm
      register: helm_installed

    # 2ï¸âƒ£ Helm ì„¤ì¹˜ (ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° ìŠ¤í‚µ)
    - name: Install Helm if not installed
      shell: "curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash"
      when: not helm_installed.stat.exists

    # 3ï¸âƒ£ Helm Repository ì¶”ê°€ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì¶”ê°€)
    - name: Check if ArgoCD Helm repository is already added
      command: helm repo list
      register: helm_repo_list
      changed_when: false

    - name: Add ArgoCD Helm repository if not exists
      command: helm repo add argo https://argoproj.github.io/argo-helm
      when: "'argo' not in helm_repo_list.stdout"

    # 4ï¸âƒ£ Helm Repository ì—…ë°ì´íŠ¸
    - name: Update Helm repositories
      command: helm repo update

    # 5ï¸âƒ£ ArgoCD ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¬´ì‹œ)
    - name: Create ArgoCD namespace if not exists
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

    # 6ï¸âƒ£ ArgoCD ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
    - name: Check if ArgoCD is already installed
      command: helm list -n argocd -q
      register: argocd_installed
      changed_when: false

    # 7ï¸âƒ£ ArgoCDê°€ ì¼ë¶€ë§Œ ì„¤ì¹˜ëœ ê²½ìš° ì œê±°
    - name: Uninstall ArgoCD if partially installed
      command: helm uninstall argocd -n argocd
      when: argocd_installed.stdout != ""
      ignore_errors: yes

    # 8ï¸âƒ£ ê¸°ì¡´ PVC ì‚­ì œ (ì™„ì „ ì œê±°í•  ê²½ìš°ë§Œ)
    - name: Delete existing ArgoCD PVCs if needed
      command: kubectl delete pvc --all -n argocd
      when: argocd_installed.stdout != ""
      ignore_errors: yes

    # 9ï¸âƒ£ ArgoCD ì„¤ì¹˜ ë˜ëŠ” ì—…ê·¸ë ˆì´ë“œ
    - name: Install or Upgrade ArgoCD using Helm
      command: >
        helm upgrade --install argocd argo/argo-cd
        --namespace argocd --create-namespace
        --atomic --cleanup-on-fail --timeout 600s

    # ğŸ”Ÿ ArgoCD ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    - name: Wait for ArgoCD server to be ready
      command: >
        kubectl wait --for=condition=available --timeout=600s deployment/argocd-server -n argocd

    # 11ï¸âƒ£ ArgoCDë¥¼ LoadBalancer ì„œë¹„ìŠ¤ë¡œ ë…¸ì¶œ (ì„ íƒì )
    - name: Expose ArgoCD server as a LoadBalancer (optional)
      command: >
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

    # 12ï¸âƒ£ ArgoCD ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Retrieve ArgoCD admin password
      shell: >
        kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 --decode
      register: argocd_password
      changed_when: false

    # 13ï¸âƒ£ ArgoCD ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ ì¶œë ¥
    - name: Print ArgoCD admin password
      debug:
        msg: "ArgoCD Admin Password: {{ argocd_password.stdout }}"
