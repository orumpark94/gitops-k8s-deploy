- name: Deploy ArgoCD + Helm for GitOps
  hosts: master
  become: yes
  tasks:

    # ðŸŸ¢ 1ï¸âƒ£ ArgoCD ì„¤ì¹˜
    - name: Create ArgoCD namespace
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

    - name: Install ArgoCD
      shell: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: Wait for ArgoCD to be ready
      shell: kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Expose ArgoCD server using port-forwarding
      shell: nohup kubectl port-forward svc/argocd-server -n argocd 8080:443 > /dev/null 2>&1 &
      async: 10
      poll: 0

    # ðŸŸ¢ 2ï¸âƒ£ ì´ˆê¸° ê´€ë¦¬ìž ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë° Secret ì„¤ì •
    - name: Get ArgoCD initial admin password
      shell: >
        kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 --decode
      register: argocd_admin_password
      changed_when: false
      ignore_errors: yes  # secretì´ ì—†ë”ë¼ë„ ì§„í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •

    - name: Log into ArgoCD CLI
      shell: argocd login localhost:8080 --username admin --password "{{ argocd_admin_password.stdout | default('')}}"
        --insecure
      ignore_errors: yes

    # ðŸŸ¢ 3ï¸âƒ£ `argocd-redis` ë° `argocd-repo-server-tls` Secret ê°•ì œ ìƒì„±
    - name: Ensure `argocd-redis` Secret exists
      shell: |
        if ! kubectl get secret -n argocd argocd-redis &> /dev/null; then
          kubectl create secret generic argocd-redis -n argocd \
            --from-literal=auth=$(openssl rand -hex 16)
        fi
      register: create_redis_secret
      changed_when: create_redis_secret.rc == 0

    - name: Ensure `argocd-repo-server-tls` Secret exists
      shell: |
        if ! kubectl get secret -n argocd argocd-repo-server-tls &> /dev/null; then
          kubectl create secret generic argocd-repo-server-tls -n argocd
        fi
      register: create_repo_tls_secret
      changed_when: create_repo_tls_secret.rc == 0

    # âœ… ðŸ› ï¸ íŠ¹ì • ìƒíƒœì˜ ArgoCD Podë§Œ ìž¬ì‹œìž‘
    - name: Restart only problematic ArgoCD Pods
      shell: |
        for pod in $(kubectl get pods -n argocd --no-headers | awk '$3 ~ /CreateContainerConfigError|CrashLoopBackOff/ {print $1}'); do
          kubectl delete pod -n argocd $pod
        done
      register: restart_problematic_pods
      changed_when: restart_problematic_pods.rc == 0

    # âœ… ðŸ› ï¸ ArgoCD Deployment ë° StatefulSet ë¡¤ë§ ì—…ë°ì´íŠ¸ (ì„œë¹„ìŠ¤ ë‹¤ìš´ ìµœì†Œí™”)
    - name: Rollout restart ArgoCD deployments
      shell: kubectl rollout restart deployment -n argocd
      register: restart_deployments
      changed_when: restart_deployments.rc == 0

    - name: Rollout restart ArgoCD statefulsets
      shell: kubectl rollout restart statefulset -n argocd
      register: restart_statefulsets
      changed_when: restart_statefulsets.rc == 0

    # ðŸŸ¢ 5ï¸âƒ£ Helm ì„¤ì¹˜ ë° ë””ë ‰í† ë¦¬ ìƒì„±
    - name: Check if Helm is installed
      shell: command -v helm
      register: helm_installed
      ignore_errors: yes
      changed_when: false

    - name: Install Helm if not installed
      shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: helm_installed.rc != 0

    - name: Ensure Helm charts directory exists
      file:
        path: charts/my-app
        state: directory
        mode: '0755'

    # ðŸŸ¢ 6ï¸âƒ£ ArgoCDì—ì„œ GitOps ì €ìž¥ì†Œ ê°ì‹œ ì„¤ì •
    - name: Add GitOps repository to ArgoCD
      shell: argocd repo add https://github.com/orumpark94/gitops-k8s-deploy.git
      ignore_errors: yes

    - name: Create ArgoCD application for Helm-based GitOps
      shell: >
        argocd app create gitops-helm-app
        --repo https://github.com/orumpark94/gitops-k8s-deploy.git
        --path charts/my-app
        --dest-server https://kubernetes.default.svc
        --dest-namespace default
        --sync-policy automated
        --helm-set replicaCount=2
      ignore_errors: yes

    - name: Sync ArgoCD application
      shell: argocd app sync gitops-helm-app
      ignore_errors: yes