- name: Deploy ArgoCD + Helm for GitOps
  hosts: master
  become: yes
  tasks:

    - name: Create ArgoCD namespace
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    - name: Retrieve or Generate ArgoCD admin password
      shell: |
        PASSWORD=$(kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 --decode || echo "")
        if [[ -z "$PASSWORD" ]]; then
          echo "No password found. Creating a new one..."
          NEW_PASSWORD=$(openssl rand -hex 16)
          kubectl create secret generic argocd-initial-admin-secret -n argocd \
            --from-literal=password=$NEW_PASSWORD --dry-run=client -o yaml | kubectl apply -f -
          echo "$NEW_PASSWORD"
        else
          echo "$PASSWORD"
        fi
      register: argocd_admin_password
      changed_when: false

    - name: Check if `argocd-redis` Secret exists
      shell: kubectl get secret argocd-redis -n argocd --no-headers --ignore-not-found
      register: redis_secret_check
      changed_when: false

    - name: Generate and apply `argocd-redis` Secret if not exists
      shell: |
        if [[ -z "$(kubectl get secret argocd-redis -n argocd --ignore-not-found)" ]]; then
          kubectl create secret generic argocd-redis -n argocd \
            --from-literal=auth=$(openssl rand -hex 16) --dry-run=client -o yaml | kubectl apply -f -
        fi
      changed_when: false

    - name: Check if `argocd-repo-server-tls` Secret exists
      shell: kubectl get secret argocd-repo-server-tls -n argocd --no-headers --ignore-not-found
      register: repo_tls_secret_check
      changed_when: false

    - name: Generate and apply `argocd-repo-server-tls` Secret if not exists
      shell: |
        if [[ -z "$(kubectl get secret argocd-repo-server-tls -n argocd --ignore-not-found)" ]]; then
          openssl req -x509 -newkey rsa:4096 -keyout /tmp/tls.key -out /tmp/tls.crt -days 365 -nodes -subj '/CN=argocd-repo-server'
          kubectl create secret generic argocd-repo-server-tls -n argocd \
            --from-file=tls.crt=/tmp/tls.crt --from-file=tls.key=/tmp/tls.key --dry-run=client -o yaml | kubectl apply -f -
          rm -f /tmp/tls.key /tmp/tls.crt
        fi
      changed_when: false

    - name: Install ArgoCD
      shell: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: Wait for ArgoCD to be ready
      shell: kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Log into ArgoCD CLI
      shell: argocd login localhost:8080 --username admin --password "{{ argocd_admin_password.stdout }}" --insecure
      register: argocd_login
      changed_when: false
      failed_when: "'logged in successfully' not in argocd_login.stdout"

    - name: Rollout restart ArgoCD deployments and statefulsets
      shell: |
        kubectl rollout restart deployment -n argocd
        kubectl rollout restart statefulset -n argocd
      changed_when: false

    - name: Ensure Helm is installed
      shell: |
        if ! command -v helm &> /dev/null; then
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
      changed_when: false

    - name: Add GitOps repository to ArgoCD
      shell: argocd repo add https://github.com/orumpark94/gitops-k8s-deploy.git
      ignore_errors: yes

    - name: Create and sync ArgoCD application
      shell: |
        argocd app create gitops-helm-app --repo https://github.com/orumpark94/gitops-k8s-deploy.git \
        --path charts/my-app --dest-server https://kubernetes.default.svc \
        --dest-namespace default --sync-policy automated --helm-set replicaCount=2
        argocd app sync gitops-helm-app
      ignore_errors: yes