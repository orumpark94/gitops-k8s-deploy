- name: Deploy ArgoCD + Helm for GitOps
  hosts: master
  become: yes
  tasks:

    - name: Create ArgoCD namespace
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    - name: Install ArgoCD
      shell: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: Wait for ArgoCD to be ready
      shell: kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Retrieve ArgoCD admin password
      shell: |
        kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 --decode
      register: argocd_admin_password
      changed_when: false

    - name: Log into ArgoCD CLI
      shell: argocd login localhost:8080 --username admin --password "{{ argocd_admin_password.stdout }}" --insecure
      register: argocd_login
      changed_when: false
      failed_when: "'logged in successfully' not in argocd_login.stdout"

    - name: Ensure Helm is installed
      shell: |
        if ! command -v helm &> /dev/null; then
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
      changed_when: false

    - name: Add GitOps repository to ArgoCD
      shell: argocd repo add https://github.com/orumpark94/gitops-k8s-deploy.git
      ignore_errors: yes

    - name: Create and sync ArgoCD application
      shell: |
        argocd app create gitops-helm-app --repo https://github.com/orumpark94/gitops-k8s-deploy.git \
        --path charts/my-app --dest-server https://kubernetes.default.svc \
        --dest-namespace default --sync-policy automated --helm-set replicaCount=2
        argocd app sync gitops-helm-app
      ignore_errors: yes
