- name: Deploy ArgoCD + Helm for GitOps
  hosts: master
  become: yes
  tasks:

    # ğŸŸ¢ 1ï¸âƒ£ ArgoCD ì„¤ì¹˜
    - name: Create ArgoCD namespace
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

    - name: Install ArgoCD
      shell: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: Wait for ArgoCD to be ready
      shell: kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Expose ArgoCD server using port-forwarding
      shell: nohup kubectl port-forward svc/argocd-server -n argocd 8080:443 > /dev/null 2>&1 &
      async: 10
      poll: 0

    # ğŸŸ¢ 2ï¸âƒ£ Helm ì„¤ì¹˜ ë° ë””ë ‰í† ë¦¬ ìƒì„±
    - name: Install Helm
      shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: Ensure Helm charts directory exists
      file:
        path: charts/my-app
        state: directory
        mode: '0755'

    # ğŸŸ¢ 3ï¸âƒ£ ArgoCDì—ì„œ GitOps ì €ì¥ì†Œ ê°ì‹œ ì„¤ì •
    - name: Add GitOps repository to ArgoCD
      shell: argocd repo add https://github.com/orumpark94/gitops-k8s-deploy.git

    - name: Create ArgoCD application for Helm-based GitOps
      shell: >
        argocd app create gitops-helm-app
        --repo https://github.com/orumpark94/gitops-k8s-deploy.git
        --path charts/my-app  # ğŸŸ¢ Helm Chartê°€ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬ ì§€ì •
        --dest-server https://kubernetes.default.svc
        --dest-namespace default
        --sync-policy automated
        --helm-set replicaCount=2  # ğŸŸ¢ Helm values.yaml ë³€ê²½ ê°€ëŠ¥

    - name: Sync ArgoCD application
      shell: argocd app sync gitops-helm-app


# --dest-server https://kubernetes.default.svc #ArgoCDê°€ ì–´ë–¤ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•  ê²ƒì¸ì§€ ì§€ì •í•˜ëŠ” ì˜µì…˜ 
# ë§Œì•½ ArgoCDê°€ ë‹¤ë¥¸ ì›ê²© Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•´ì•¼ í•œë‹¤ë©´, í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì˜ API ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤. --dest-server https://123.45.67.89:6443
# https://kubernetes.default.svc â†’ ArgoCDê°€ ì‹¤í–‰ ì¤‘ì¸ í´ëŸ¬ìŠ¤í„° (ë¡œì»¬ Kubernetes í´ëŸ¬ìŠ¤í„°)ë¥¼ ì˜ë¯¸í•¨.

# --dest-namespace default ArgoCDê°€ ë°°í¬í•  Kubernetes ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì§€ì •í•˜ëŠ” ì˜µì…˜
# default â†’ ê¸°ë³¸ì ìœ¼ë¡œ Kubernetes í´ëŸ¬ìŠ¤í„°ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤

